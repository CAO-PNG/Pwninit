#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"

CLIBC_SOURCE="${ROOT}/bin/clibc"
PWNINIT_SOURCE="${ROOT}/bin/pwninit"
CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/clibc"
CONF_FILE="${CONF_DIR}/config"

log() { printf '[*] %s\n' "$*"; }
warn() { printf '[!] %s\n' "$*" >&2; }
die() {
  printf '[-] %s\n' "$*" >&2
  exit 1
}

is_interactive() {
  [[ -t 0 ]]
}

expand_home() {
  local p="$1"
  if [[ "$p" == "~" ]]; then
    printf '%s\n' "$HOME"
  elif [[ "$p" == "~/"* ]]; then
    printf '%s\n' "$HOME/${p#~/}"
  else
    printf '%s\n' "$p"
  fi
}

prompt_with_default() {
  local outvar="$1"
  local text="$2"
  local default="$3"
  local val=""

  if is_interactive; then
    read -r -p "$text [$default]: " val || true
  fi
  if [[ -z "$val" ]]; then
    val="$default"
  fi
  printf -v "$outvar" '%s' "$val"
}

prompt_yes_no() {
  local outvar="$1"
  local text="$2"
  local default="$3"
  local val=""

  if is_interactive; then
    read -r -p "$text [$default]: " val || true
  fi
  if [[ -z "$val" ]]; then
    val="$default"
  fi
  case "$val" in
    y|Y|yes|YES) printf -v "$outvar" '%s' "1" ;;
    n|N|no|NO) printf -v "$outvar" '%s' "0" ;;
    *)
      warn "Unknown answer '$val', fallback to '$default'."
      if [[ "$default" =~ ^(y|Y|yes|YES)$ ]]; then
        printf -v "$outvar" '%s' "1"
      else
        printf -v "$outvar" '%s' "0"
      fi
      ;;
  esac
}

write_config() {
  local aio_dir="$1"
  local ubuntu_cache="$2"
  local docker_cache="$3"
  local proxy="$4"
  local debug="$5"

  mkdir -p -- "$CONF_DIR"
  {
    printf '# Auto-generated by install on %s\n' "$(date '+%Y-%m-%d %H:%M:%S')"
    printf '# Edit this file to update defaults for clibc/pwninit.\n\n'
    printf 'GLIBC_AIO_DIR=%q\n' "$aio_dir"
    printf 'CLIBC_UBUNTU_CACHE_DIR=%q\n' "$ubuntu_cache"
    printf 'CLIBC_DOCKER_CACHE_DIR=%q\n' "$docker_cache"
    if [[ -n "$proxy" ]]; then
      printf 'CLIBC_PROXY=%q\n' "$proxy"
    else
      printf '# CLIBC_PROXY=\n'
    fi
    printf 'CLIBC_DEBUG=%q\n' "$debug"
  } >"$CONF_FILE"
  log "Wrote config: $CONF_FILE"
}

append_path_rc() {
  local dest="$1"
  local line
  line="export PATH=\"$dest:\$PATH\""

  local rc="${HOME}/.bashrc"
  if [[ -n "${SHELL:-}" && "$(basename -- "$SHELL")" == "zsh" ]]; then
    rc="${HOME}/.zshrc"
  fi

  if [[ -f "$rc" ]] && grep -Fq "$line" "$rc"; then
    log "PATH entry already exists in $rc"
    return 0
  fi
  printf '\n# Added by clibc/pwninit installer\n%s\n' "$line" >>"$rc"
  log "Appended PATH entry to $rc"
}

prepare_conf_target() {
  local preferred_dir="$CONF_DIR"

  if mkdir -p -- "$preferred_dir" 2>/dev/null; then
    local probe="$preferred_dir/.clibc-write-test.$$"
    if touch -- "$probe" >/dev/null 2>&1; then
      rm -f -- "$probe"
      return 0
    fi
  fi

  warn "Cannot write config dir '$preferred_dir', fallback to project local config."
  CONF_DIR="${ROOT}/etc"
  CONF_FILE="${CONF_DIR}/clibc.conf"
  mkdir -p -- "$CONF_DIR" || die "Cannot create fallback config dir: $CONF_DIR"
}

[[ -f "$CLIBC_SOURCE" ]] || die "Missing entrypoint: $CLIBC_SOURCE"
[[ -f "$PWNINIT_SOURCE" ]] || die "Missing entrypoint: $PWNINIT_SOURCE"

log "Starting install for clibc + pwninit"
if ! is_interactive; then
  log "Non-interactive shell detected, using defaults."
fi

DEFAULT_DEST="${HOME}/.local/bin"
DEFAULT_AIO="${GLIBC_AIO_DIR:-$HOME/CTF_PWN/tools/glibc-all-in-one}"
DEFAULT_UBUNTU_CACHE="${CLIBC_UBUNTU_CACHE_DIR:-$DEFAULT_AIO/Ubuntu_Download}"
DEFAULT_DOCKER_CACHE="${CLIBC_DOCKER_CACHE_DIR:-$DEFAULT_AIO/Docker_Download}"
DEFAULT_PROXY="${CLIBC_PROXY:-${HTTPS_PROXY:-${https_proxy:-}}}"
DEFAULT_DEBUG="${CLIBC_DEBUG:-0}"

prompt_with_default DEST "Install bin directory" "$DEFAULT_DEST"
DEST="$(expand_home "$DEST")"
prompt_with_default GLIBC_AIO_DIR_IN "glibc-all-in-one path" "$DEFAULT_AIO"
GLIBC_AIO_DIR_IN="$(expand_home "$GLIBC_AIO_DIR_IN")"
prompt_with_default UBUNTU_CACHE_IN "Ubuntu package cache path" "$DEFAULT_UBUNTU_CACHE"
UBUNTU_CACHE_IN="$(expand_home "$UBUNTU_CACHE_IN")"
prompt_with_default DOCKER_CACHE_IN "Docker library cache path" "$DEFAULT_DOCKER_CACHE"
DOCKER_CACHE_IN="$(expand_home "$DOCKER_CACHE_IN")"
prompt_with_default PROXY_IN "Default proxy (blank means no override)" "$DEFAULT_PROXY"
prompt_with_default DEBUG_IN "Enable debug by default? (0/1)" "$DEFAULT_DEBUG"
case "$DEBUG_IN" in
  0|1) ;;
  *)
    warn "Invalid debug value '$DEBUG_IN', using 0."
    DEBUG_IN="0"
    ;;
esac

prompt_yes_no CREATE_CACHE_DIRS "Create cache directories now? (y/n)" "y"
prompt_yes_no AUTO_PATH "Auto add PATH to shell rc? (y/n)" "n"

mkdir -p -- "$DEST"

if [[ "$CREATE_CACHE_DIRS" == "1" ]]; then
  mkdir -p -- "$GLIBC_AIO_DIR_IN" "$UBUNTU_CACHE_IN" "$DOCKER_CACHE_IN"
  log "Ensured cache directories exist."
fi

prepare_conf_target
write_config "$GLIBC_AIO_DIR_IN" "$UBUNTU_CACHE_IN" "$DOCKER_CACHE_IN" "$PROXY_IN" "$DEBUG_IN"

CLIBC_TARGET="${DEST}/clibc"
PWNINIT_TARGET="${DEST}/pwninit"

if [[ -e "$CLIBC_TARGET" || -L "$CLIBC_TARGET" ]]; then
  warn "$CLIBC_TARGET already exists, replacing..."
  rm -f -- "$CLIBC_TARGET"
fi
if [[ -e "$PWNINIT_TARGET" || -L "$PWNINIT_TARGET" ]]; then
  warn "$PWNINIT_TARGET already exists, replacing..."
  rm -f -- "$PWNINIT_TARGET"
fi

ln -s -- "$CLIBC_SOURCE" "$CLIBC_TARGET"
ln -s -- "$PWNINIT_SOURCE" "$PWNINIT_TARGET"

log "Installed: $CLIBC_TARGET -> $CLIBC_SOURCE"
log "Installed: $PWNINIT_TARGET -> $PWNINIT_SOURCE"

if [[ "$AUTO_PATH" == "1" ]]; then
  append_path_rc "$DEST"
fi

log "Install complete."
log "Try: clibc --list"
log "Try: pwninit --help"
